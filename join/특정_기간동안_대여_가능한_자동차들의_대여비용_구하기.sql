SELECT C.CAR_ID, C.CAR_TYPE,
    FLOOR(C.DAILY_FEE * (100 - D.DISCOUNT_RATE) / 100 * 30) FEE
FROM (
    SELECT B.CAR_ID, B.CAR_TYPE, B.DAILY_FEE
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY A
    RIGHT JOIN CAR_RENTAL_COMPANY_CAR B
    ON A.CAR_ID = B.CAR_ID
    WHERE B.CAR_TYPE IN ('세단', 'SUV')
    GROUP BY A.CAR_ID
    HAVING SUM(IF((A.START_DATE < '2022-11-01' AND A.END_DATE >= '2022-11-01')
                 OR (A.START_DATE < '2022-12-01' AND A.END_DATE >= '2022-12-01')
                 OR ((A.START_DATE BETWEEN '2022-11-01' AND '2022-11-30')
                         AND (A.END_DATE BETWEEN '2022-11-01' AND '2022-11-30')), 1, 0)) = 0) C
JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN D
ON D.CAR_TYPE = C.CAR_TYPE
    AND D.DURATION_TYPE = '30일 이상'
WHERE FLOOR(C.DAILY_FEE * (100 - D.DISCOUNT_RATE) / 100 * 30) BETWEEN 500000 AND 1999999
ORDER BY FEE DESC, C.CAR_TYPE, C.CAR_ID DESC